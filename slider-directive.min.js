"use strict";angular.module("jackrabbitsgroup.angular-slider-directive",[]).directive("jrgSliderDirective",["jrgPolynomial","jrgSliderService",function(e,t){var l="";return l+="<div id = '{{slider_id}}' ng-mousemove = 'mousemoveHandler($event); $event.preventDefault()' class = '{{container_class}}'>",l+="<div ng-click = 'barClickHandler($event)' class = '{{bar_container_class}}' ng-style = 'bar_container_style'>",l+="<div id = '{{slider_id}}SliderBar' style = 'position:relative; width:100%;'>",l+='<div class = \'{{left_bg_class}}\' ng-style = \'{"width": left_bg_width + "%", "position": "absolute",  "left": "0%"}\'> </div>',l+="<div ng-repeat = 'handle in handles' id = '{{slider_id}}Handle{{$index}}' ng-mousedown = 'startHandleDrag($index); $event.preventDefault()' class = '{{handle_class}}' ng-style = '{\"z-index\": handle.zindex, \"left\": handle.left + \"%\", \"position\": \"absolute\"}' ng-bind-html = 'handle.innerhtml'></div>",l+='<div ng-repeat = \'interior in interiors\' class = \'{{interior_bg_class}}\' ng-style = \'{"left": interior.left + "%", "width": interior.width + "%", "position": "absolute"}\'> </div>',l+='<div class = \'{{right_bg_class}}\' ng-style = \'{"width": right_bg_width + "%", "position": "absolute", "right": "0%"}\'> </div>',l+="<div>",l+='<div ng-repeat = \'tick in ticks\' class = \'{{ticks_class}}\' ng-style = \'{"position": "absolute", "left": tick.left + "%"}\'> </div>',l+="</div>",l+="</div>",l+="<div class = '{{ticks_values_container_class}}' style = 'position: relative;' ng-show = 'use_ticks'>",l+='<div ng-repeat = \'tick in ticks\' class = \'{{ticks_value_class}}\' ng-style = \'{"position": "absolute", "left": tick.left + "%"}\'> {{tick.name}} </div>',l+="</div>",l+="</div>",l+="</div>",{restrict:"E",priority:0,scope:{handle_values:"=sliderHandleVariable",slider_id:"@sliderId",slider_opts:"=sliderOpts"},replace:!0,template:l,link:function(l,n,a){var i,r,s,o,u,d,v,_,c,f,h,m,g;r={num_handles:1,slider_min:0,slider_max:100,precision:0,scale_string:"[1, 1]",zero_method:"newton",increment:0,user_values:"",evt_mouseup:"",slider_moveable:!0,use_array:!0,rotate:0,bar_container_class:"jrg-slider-directive-bar",left_bg_class:"jrg-slider-directive-bar-active",interior_bg_class:"jrg-slider-directive-bar-active",right_bg_class:"jrg-slider-directive-bar-inactive",handle_class:"jrg-slider-directive-bar-handle",handle_html:'<div class = "jrg-slider-directive-bar-handle-inner"></div>',units_pre:"",units_post:"",use_ticks:!1,ticks_values:"placeholder",ticks_class:"jrg-slider-directive-ticks",ticks_values_container_class:"jrg-slider-directive-ticks-values-container",ticks_value_class:"jrg-slider-directive-ticks-value"};var p={evt_get_value:"",evt_return_value:"",evt_get_all_values:"",evt_return_all_values:"",evt_set_value:"",evt_init_slider:"",evt_init_slider_finished:""},y={evt_get_value:function(){},evt_get_all_values:function(){},evt_set_value:function(){},evt_init_slider:function(){}};u=e.stringToPoly("[1, 1]");var b=function(){s=!0,o=!1;for(var e in r)void 0===l.slider_opts[e]||null===l.slider_opts[e]?l[e]=r[e]:l[e]=l.slider_opts[e];if("placeholder"==l.ticks_values&&(l.user_values.length>0?l.ticks_values=[l.user_values[0],l.user_values[l.user_values.length-1]]:l.ticks_values=[l.slider_min,l.slider_max]),X(),t.register(l.slider_id,R),l.initial_values=!1,l.handle_values){if(Y(l.handle_values)===!1)l.initial_values=l.handle_values;else if(void 0!==l.handle_values.length&&l.handle_values.length>0){var n=[];for(i=0;i<l.handle_values.length;i++)n[i]=l.handle_values[i];l.initial_values=n}}else l.use_array=k(l.use_array,r.use_array),l.use_array===!1?l.handle_values="":l.handle_values=[];x(),P(),w(),l.use_ticks===!0&&$(),j(),s=!1,o===!0?b():l.$emit(p.evt_init_slider_finished,{id:l.slider_id,values:l.handle_values})},x=function(){if(l.num_handles=parseInt(l.num_handles,10),l.slider_min=parseFloat(l.slider_min),l.slider_max=parseFloat(l.slider_max),l.increment=parseFloat(l.increment),l.precision=parseInt(l.precision,10),l.rotate=F(parseFloat(l.rotate)),l.slider_moveable=k(l.slider_moveable,r.slider_moveable),l.use_array=k(l.use_array,r.use_array),m=!1,""!==l.user_values&&l.user_values){for(m=!0,i=0;i<l.user_values.length;i++)if(void 0===l.user_values[i].val||null===l.user_values[i].val){var t=l.user_values[i];l.user_values[i]={val:t,name:t}}else(void 0===l.user_values[i].name||null===l.user_values[i].name)&&(l.user_values[i].name=l.user_values[i].val);l.slider_min=0,l.slider_max=l.user_values.length-1,l.increment=1,l.precision=0}l.left_bg_width=0,l.right_bg_width=0,d=0,v=!1,l.recent_dragging=!1,l.handles=[],l.interiors=[],l.ticks=[],h=[],_={x:0,y:0},c=100,f=!1,g=l.rotate*(2*Math.PI/360),0!==l.rotate&&90!==l.rotate&&-90!==l.rotate&&180!==l.rotate&&(_.m1=Math.tan(g),_.m2=-1/_.m1),0===l.increment&&(u=e.stringToPoly(l.scale_string))},k=function(e,t){return"false"==e||e===!1?!1:"true"==e||e===!0?!0:t},P=function(){var e="rotate("+l.rotate+"deg)";l.bar_container_style={"-moz-transform":e,"-webkit-transform":e,"-o-transform":e,"-ms-transform":e,transform:e}},w=function(){var e;if(-1!=l.handle_html.indexOf("~"))for(e=l.handle_html.split("~"),i=e.length;i<l.num_handles;i++)e[i]="";else for(e=[],i=0;i<l.num_handles;i++)e[i]=l.handle_html;for(i=0;i<l.num_handles;i++){var t;1==l.num_handles?(t=0,l.right_bg_width=100):t=100/(l.num_handles-1)*i;var n=!1;-1!=e[i].indexOf("$$value")&&(n=!0),l.handles[i]={zindex:10,left:t,value:S(t),html_string:e[i],value_in_handle:n},m===!1?(l.handles[i].display_value=l.handles[i].value,l.handles[i].return_value=l.handles[i].value):(l.handles[i].display_value=l.user_values[l.handles[i].value].name,l.handles[i].return_value=l.user_values[l.handles[i].value].val),l.use_array===!1?l.handle_values=l.handles[i].return_value:l.handle_values[i]=l.handles[i].return_value,B(i),l.handles[i].value_in_handle===!0?C(i):l.handles[i].innerhtml=l.handles[i].html_string}for(i=0;i<l.num_handles-1;i++)l.interiors[i]={left:l.handles[i].left,width:l.handles[i+1].left-l.handles[i].left};if(0!==l.increment&&l.increment){var a=l.slider_min;for(i=0;a<l.slider_max;i++)h[i]={},h[i].value=a,h[i].left=H(a),a+=l.increment;if(h[i]={},h[i].value=l.slider_max,h[i].left=100,l.initial_values===!1){var r=[];for(i=0;i<l.num_handles;i++){var s=V(l.handles[i].left);r[i]={handle:i,distance:Math.abs(l.handles[i].left-s),new_left:s}}for(r.sort(function(e,t){return e.distance<t.distance?-1:t.distance<e.distance?1:0}),i=0;i<l.num_handles;i++)Z(r[i].handle,r[i].new_left)}}if(l.initial_values===!1);else for((""===p.evt_set_value||void 0===p.evt_set_value||null===p.evt_set_value)&&X(),i=0;i<l.num_handles;i++)l.use_array===!1?N(i,l.initial_values):N(i,l.initial_values[i])},$=function(){for(var e=0;e<l.ticks_values.length;e++){void 0===l.ticks_values[e].val||null===l.ticks_values[e].val?l.ticks[e]={val:l.ticks_values[e],name:l.units_pre+l.ticks_values[e]+l.units_post}:void 0===l.ticks_values[e].name||null===l.ticks_values[e].name?l.ticks[e]={val:l.ticks_values[e].val,name:l.units_pre+l.ticks_values[e].val+l.units_post}:l.ticks[e]={val:l.ticks_values[e].val,name:l.ticks_values[e].name};var t;if(m===!0){var n,a;for(a=0;a<l.user_values.length;a++)l.user_values[a].val.toString()==l.ticks[e].val.toString()&&(n=a,a=l.user_values.length);t=h[n].left}else t=H(l.ticks[e].val);l.ticks[e].left=t}},j=function(){var e=function(){if(document.getElementById(l.slider_id+"Handle0")){for(i=0;i<l.num_handles;i++)!function(e){var t=angular.element(document.getElementById(l.slider_id+"Handle"+e));t.unbind("touchstart"),t.bind("touchstart",function(t){t.preventDefault(),void 0===l.$$phase||null===l.$$phase?l.$apply(function(){l.startHandleDrag(e)}):l.startHandleDrag(e)})}(i);var t=angular.element(document.getElementById(l.slider_id));t.unbind("touchmove"),t.bind("touchmove",function(e){e.preventDefault();var t=e.originalEvent.touches[0];void 0===l.$$phase||null===l.$$phase?l.$apply(function(){l.mousemoveHandler(t)}):l.mousemoveHandler(t)})}else setTimeout(function(){l.$apply(function(){e()})},500)};e()},S=function(t){return E(l.slider_min+(l.slider_max-l.slider_min)*e.evalPoly(u,t/100),l.precision)},M=function(t){var n,a=e.subPoly(u,e.buildPoly([t],[0]));if("bisection"!=l.zero_method){var i=e.findPolyZeroNewton({poly:a,guess:t});return i.err?(n=e.findPolyZeroBisection({poly:a,a:0,b:1}),n.val):i.val}return n=e.findPolyZeroBisection({poly:a,a:0,b:1}),n.val},H=function(e){return 100*M((e-l.slider_min)/(l.slider_max-l.slider_min))},T=function(e){0!==e?(l.interiors[e-1].left=l.handles[e-1].left,l.interiors[e-1].width=l.handles[e].left-l.handles[e-1].left):l.left_bg_width=l.handles[e].left,e<l.num_handles-1?(l.interiors[e].left=l.handles[e].left,l.interiors[e].width=l.handles[e+1].left-l.handles[e].left):l.right_bg_width=100-l.handles[e].left},B=function(e){l.handles[e].left<2?l.handles[e].zindex=10+e+1:l.handles[e].zindex=10+l.num_handles-e},E=function(e,t){if(t>=0)return parseFloat(e.toFixed(t));var l=Math.pow(10,-1*t);return l*Math.round(e/l)},F=function(e){for(;e>180;)e-=360;for(;-180>=e;)e+=360;return e},O=function(e){var t,l,n,a;if(e)return n=e.getBoundingClientRect(),n.width||n.height||e.getClientRects().length?(a=e.ownerDocument,l=a.defaultView,t=a.documentElement,{top:n.top+l.pageYOffset-t.clientTop,left:n.left+l.pageXOffset-t.clientLeft}):void 0},I=function(){if(l.slider_moveable===!0||f===!1){var e=document.getElementById(l.slider_id+"SliderBar");c=e.offsetWidth,_.x=O(e).left,_.y=O(e).top,l.rotate<0&&(_.y+=c*Math.abs(Math.sin(g))),(l.rotate>90||l.rotate<-90)&&(_.x+=c*Math.abs(Math.cos(g))),_.m1&&(_.b1=-1*_.m1*_.x+_.y),f=!0}};l.barClickHandler=function(e){if(l.recent_dragging===!1){I();var t,n;-1!==e.type.indexOf("touch")?(t=e.changedTouches[0].pageX,n=e.changedTouches[0].pageY):(t=e.pageX,n=e.pageY);var a=z(t,n);0!==l.increment&&l.increment&&(a=V(a));var r=0;if(l.handles[l.num_handles-1].left<=a)r=l.num_handles-1;else if(l.handles[0].left>=a)r=0;else{for(i=0;a>l.handles[i].left;i++);r=l.handles[i].left-a>a-l.handles[i-1].left?i-1:i}Z(r,a),""!==l.evt_mouseup&&l.evt_mouseup&&l.$emit(l.evt_mouseup,{num_handles:l.num_handles,handle:r,id:l.slider_id,value:l.handles[r].return_value})}},l.startHandleDrag=function(e){I(),d=e,v=!0,l.recent_dragging=!0,t.activate(l.slider_id)},l.mousemoveHandler=function(e){v===!0&&D(e)};var D=function(e){var t,n;t=e.pageX,n=e.pageY;var a=z(t,n);0!==l.increment&&l.increment&&(a=V(a)),Z(d,a)},z=function(e,t){if(0===l.rotate)return(e-_.x)/c*100;if(180===l.rotate)return(_.x-e)/c*100;if(90===l.rotate)return(t-_.y)/c*100;if(-90===l.rotate)return(_.y-t)/c*100;var n=(t-_.m2*e-_.b1)/(_.m1-_.m2),a=_.m1*n+_.b1;if(l.rotate<90&&l.rotate>-90&&n<=_.x)return 0;if(l.rotate>90&&l.rotate<-90&&n>=_.x)return 0;var i=Math.sqrt(Math.pow(_.x-n,2)+Math.pow(_.y-a,2)),r=i/c*100;return r},Z=function(e,t){e<l.num_handles-1&&t>l.handles[e+1].left?t=l.handles[e+1].left:e>0&&t<l.handles[e-1].left?t=l.handles[e-1].left:0>t?t=0:t>100&&(t=100),l.handles[e].left=t,l.handles[e].value=S(t),m===!1?(l.handles[e].display_value=l.handles[e].value,l.handles[e].return_value=l.handles[e].value):(l.handles[e].display_value=l.user_values[l.handles[e].value].name,l.handles[e].return_value=l.user_values[l.handles[e].value].val),l.handles[e].value_in_handle===!0&&C(e),l.use_array===!1?l.handle_values=l.handles[e].return_value:l.handle_values[e]=l.handles[e].return_value,T(e),B(e)},R=function(){var e=function(){v===!0&&(v=!1,t.deactivate(),""!==l.evt_mouseup&&l.evt_mouseup&&l.$emit(l.evt_mouseup,{num_handles:l.num_handles,handle:d,id:l.slider_id,value:l.handles[d].return_value}),setTimeout(function(){l.$apply(function(){l.recent_dragging=!1})},300))};void 0===l.$$phase||null===l.$$phase?l.$apply(function(){e()}):e()},V=function(e){if(e>=100)return 100;if(0>=e)return 0;var t=h[1].left,l=Math.floor(e/t);return e-h[l].left<h[l+1].left-e?h[l].left:h[l+1].left},C=function(e){l.handles[e].innerhtml=l.handles[e].html_string.replace("$$value",l.units_pre+l.handles[e].display_value+l.units_post)},N=function(e,t){var n;if(m===!0){for(var a,i=0;i<l.user_values.length;i++)l.user_values[i].val.toString()==t.toString()&&(a=i,i=l.user_values.length);n=h[a].left}else n=H(t);Z(e,n)},X=function(){p.evt_get_value="evtSliderGetValue"+l.slider_id,p.evt_return_value="evtSliderReturnValue"+l.slider_id,p.evt_get_all_values="evtSliderGetAllValues"+l.slider_id,p.evt_return_all_values="evtSliderReturnAllValues"+l.slider_id,p.evt_set_value="evtSliderSetValue"+l.slider_id,p.evt_init_slider="evtInitSlider"+l.slider_id,p.evt_init_slider_finished="evtSliderInitialized"+l.slider_id,y.evt_get_value(),y.evt_get_all_values(),y.evt_set_value(),y.evt_init_slider(),y.evt_get_value=l.$on(p.evt_get_value,function(e,t){var n=0;t&&t.handle&&(n=t.handle),l.$emit(p.evt_return_value,{value:l.handles[n].return_value})}),y.evt_get_all_values=l.$on(p.evt_get_all_values,function(e,t){var n=[];for(i=0;i<l.handles.length;i++)n[i]=l.handles[i].return_value;l.$emit(p.evt_return_all_values,{values:n})}),y.evt_set_value=l.$on(p.evt_set_value,function(e,t){var l=0;t&&t.handle&&(l=t.handle),N(l,t.value)}),y.evt_init_slider=l.$on(p.evt_init_slider,function(e,t){s===!0?o=!0:b()})};document.ready=function(){j()};var Y=function(e){return"[object Array]"===Object.prototype.toString.apply(e)?!0:!1},A=l.slider_id;b(),a.$observe("sliderId",function(e){t.remove(A),A=e,b()})}}}]).factory("jrgSliderService",[function(){var e={sliders:{},active:!1,register:function(e,t){this.sliders[e]=t},remove:function(e){delete this.sliders[e]},activate:function(e){this.active=e},deactivate:function(){this.active=!1},clickHandler:function(e){e.active===!1||e.sliders[e.active]()},init:function(){var e=this;window.addEventListener("mouseup",function(t){e.clickHandler(e,t)}),angular.element(window).bind("touchend",function(t){e.clickHandler(e,t)})}};return e.init(),e}]).factory("jrgPolynomial",[function(){var e={buildPoly:function(e,t){var l,n=[];for(l=0;l<e.length;l++)n[l]={coeff:e[l],exp:t[l]};return n},stringToPoly:function(e){var t,l=e.split("~"),n=[];for(t=0;t<l.length;t++)n[t]={},n[t].coeff=parseFloat(l[t].slice(l[t].indexOf("[")+1),l[t].slice(l[t].indexOf(",")-1)),n[t].exp=parseFloat(l[t].slice(l[t].indexOf(",")+1),l[t].slice(l[t].indexOf("]")-1));return n},evalPoly:function(e,t){var l,n=0;for(l=0;l<e.length;l++)n+=e[l].coeff*Math.pow(t,e[l].exp);return n},polyToFunction:function(e){var t=this;return function(l){return t.evalPoly(e,l)}},differentiatePoly:function(e){var t,l=this,n=l.copyPoly(e);for(t=0;t<n.length;t++)0===n[t].exp?n[t].coeff=0:(n[t].coeff=n[t].coeff*n[t].exp,n[t].exp=n[t].exp-1);return n},integratePoly:function(e){var t,l=this,n=l.copyPoly(e);for(t=0;t<n.length;t++){if(-1===n[t].exp)return console.log("ERROR: jrgPolynomial.integratePoly can't handle polynomials with an exponent = -1 term!"),e;n[t].exp=n[t].exp+1,n[t].coeff=n[t].coeff/n[t].exp}return n},combinePolyTerms:function(e){var t,l,n=[],a=0;for(e=e.sort(function(e,t){return e.exp<t.exp?-1:e.exp>t.exp?1:0}),l=e[0].exp,n[a]={coeff:0,exp:l},t=0;t<e.length;t++)l==e[t].exp?n[a].coeff=n[a].coeff+e[t].coeff:(a++,l=e[t].exp,n[a]={coeff:e[t].coeff,exp:l});return n},scalePoly:function(e,t){var l,n=this,a=n.copyPoly(e);for(l=0;l<a.length;l++)a[l].coeff=a[l].coeff*t;return a},addPoly:function(e,t){return this.combinePolyTerms(e.concat(t))},subPoly:function(e,t){return this.addPoly(e,this.scalePoly(t,-1))},findPolyZeroNewton:function(e){var t=this;if(void 0===e||null===e||void 0===e.poly||null===e.poly||void 0===e.guess||null===e.guess)return console.log("Error in jrgPolynomial.findPolyZeroNewton: params.poly and params.guess must be defined"),{err:!0,val:0};var l=e.poly,n=e.guess,a=1e-5;e.epsilon&&(a=e.epsilon);var i=50;if(e.max_iterations&&(i=e.max_iterations),Math.abs(t.evalPoly(l,n))<a)return{err:!1,val:n};var r=t.polyToFunction(l),s=t.polyToFunction(t.differentiatePoly(l)),o=0,u=function(e){return Math.abs(r(e))<a?{err:!1,val:e}:(o++,o>i?(console.log("Error in jrgPolynomial.findPolyZeroNewton: Too many iterations without finding answer"),{err:!0,val:e}):u(0===s(e)?e+.1:e-r(e)/s(e)))};return u(n-r(n)/s(n))},findPolyZeroBisection:function(e){var t=this;if(void 0===e||null===e||void 0===e.poly||null===e.poly||void 0===e.a||null===e.a||void 0===e.b||null===e.b)return console.log("Error in jrgPolynomial.findPolyZeroBisection: params.poly, params.a, and params.b must be defined"),{err:!0,val:0};var l=e.poly,n=1e-4;e.epsilon&&(n=e.epsilon);var a=t.polyToFunction(l),i=function(e,t){var l=a(e),r=a(t);if(Math.abs(l)<n)return{err:!1,val:e};if(Math.abs(r)<n)return{err:!1,val:t};if(l>0&&r>0||0>l&&0>r)return console.log("Error in jrgPolynomial.findPolyZeroBisection: Bad interval. The polynomial must be >= 0 at one endpoint and <= 0 at the other."),{err:!0,val:0};var s=(e+t)/2,o=a(s);return Math.abs(o)<n?{err:!1,val:s}:0>o?l>0?i(e,s):i(s,t):0>l?i(e,s):i(s,t)};return i(e.a,e.b)},copyPoly:function(e){var t,l=[];for(t=0;t<e.length;t++)l[t]={coeff:e[t].coeff,exp:e[t].exp};return l}};return e}]);